<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreykeryy AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Ensure html and body take full height */
            overflow: hidden; /* Prevent scrollbars on body */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f2f5; /* Light background */
            transition: background-color 0.3s ease;
        }

        /* Dark theme styles */
        body.dark-theme {
            background-color: #1a1a1a; /* Dark background */
        }

        .glass-container {
            background-color: rgba(255, 255, 255, 0.2); /* Light transparent background */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%; /* Take full width */
            height: 100%; /* Ensure full height within body */
            max-width: 600px; /* Max width for desktop, for a mobile-like feel */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        @media (max-width: 768px) {
            .glass-container {
                border-radius: 0; /* No rounded corners on small screens for full-bleed effect */
                max-width: 100%;
                height: 100vh; /* Explicitly use vh for mobile to ensure full screen */
            }
        }

        .header, .input-area {
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .dark-theme .header, .dark-theme .input-area {
            background-color: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 15px;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .user-bubble {
            background-color: var(--accent-color, #fcd34d); /* Default light yellow */
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-bubble {
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .dark-theme .ai-bubble {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .ai-bubble strong { color: #333; }
        .dark-theme .ai-bubble strong { color: #e0e0e0; }

        /* Code block styling */
        .ai-bubble pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.8rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 0.5rem;
            font-family: 'Fira Code', 'Cascadia Code', monospace; /* More programming friendly font */
            font-size: 0.9em;
            line-height: 1.4;
        }
        .dark-theme .ai-bubble pre {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .ai-bubble code {
            /* For inline code, keep previous style */
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .dark-theme .ai-bubble code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Basic Syntax Highlighting */
        .code-comment { color: #6a9955; } /* Green */
        .code-keyword { color: #569cd6; } /* Blue */
        .code-string { color: #ce9178; } /* Orange */
        .code-number { color: #b5cea8; } /* Light Green */
        .dark-theme .code-comment { color: #85c26b; }
        .dark-theme .code-keyword { color: #6cb6ff; }
        .dark-theme .code-string { color: #d69d85; }
        .dark-theme .code-number { color: #c0e0b8; }


        .ai-bubble blockquote {
            border-left: 4px solid var(--accent-color, #fcd34d);
            padding-left: 10px;
            margin-left: 0;
            font-style: italic;
            color: #555;
        }
        .dark-theme .ai-bubble blockquote {
            color: #bbb;
        }

        .input-box {
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            outline: none;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            flex-grow: 1;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-theme .input-box {
            background-color: rgba(50, 50, 50, 0.8);
            color: #e0e0e0;
        }

        .action-button {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .action-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .dark-theme .modal-content {
            background-color: rgba(0, 0, 0, 0.9);
            color: #e0e0e0;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .model-option {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            display: flex; /* Added for icon alignment */
            align-items: center; /* Added for icon alignment */
            gap: 0.75rem; /* Space between icon and text */
        }

        .dark-theme .model-option {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .model-option:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .dark-theme .model-option:hover {
            background-color: rgba(70, 70, 70, 0.9);
        }

        .model-option.selected {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            font-weight: 600;
        }

        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }

        .color-circle.selected {
            border-color: var(--accent-color, #fcd34d);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        .dark-theme .color-circle.selected {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.5);
        }

        /* Post-response actions */
        .post-response-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.5rem;
            gap: 0.5rem;
        }

        .post-response-button {
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .dark-theme .post-response-button {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .post-response-button:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        .dark-theme .post-response-button:hover {
            background-color: rgba(70, 70, 70, 0.9);
        }

        /* Message box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .dark-theme .message-box-content {
            background-color: rgba(0, 0, 0, 0.95);
            color: #e0e0e0;
        }

        .message-box-overlay.active .message-box-content {
            transform: scale(1);
        }

        .message-box-content button {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .message-box-content button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Loading indicator for AI response */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 20px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color, #fcd34d);
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="light-theme h-full">
    <div class="glass-container">
        <div class="header p-4 flex items-center justify-between rounded-t-2xl">
            <div class="flex items-center gap-2">
                <img id="kreykeryyLogo" src="https://placehold.co/40x40/fcd34d/333?text=K" alt="Kreykeryy Logo" class="rounded-full">
                <h1 class="text-xl font-semibold text-gray-800 dark:text-white">Kreykeryy</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="settingsBtn" class="text-gray-600 dark:text-gray-300 text-2xl hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                    <i class="fas fa-cog"></i> </button>
            </div>
        </div>

        <div id="chatMessages" class="chat-messages flex flex-col">
            <div class="message-bubble ai-bubble flex items-center gap-2">
                <img id="aiIconInitial" src="https://placehold.co/24x24/fcd34d/333?text=K" alt="AI Icon" class="rounded-full">
                <p>Привет! Я Kreykeryy, ваш персональный ИИ-помощник. Чем могу помочь?</p>
            </div>
        </div>

        <div class="input-area p-4 flex items-center gap-3 rounded-b-2xl">
            <input type="file" id="fileInput" accept=".txt,image/*" class="hidden">
            <button id="fileUploadBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-paperclip"></i>
            </button>
            <button id="modelSelectBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-box"></i> </button>
            <input type="text" id="messageInput" placeholder="Введите ваше сообщение..." class="input-box">
            <button id="sendMessageBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="modelSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Выбор Модели ИИ</h2>
            <div class="flex flex-col gap-2">
                <div class="model-option" data-model="R1">
                    <img src="https://placehold.co/30x30/fcd34d/333?text=R1" class="rounded-full" alt="R1 Icon">
                    Kreyker R1 - Общий поиск в интернете
                </div>
                <div class="model-option" data-model="R2">
                    <img src="https://placehold.co/30x30/fca5a5/333?text=R2" class="rounded-full" alt="R2 Icon">
                    Kreyker R2 - С Gemini
                </div>
                <div class="model-option" data-model="S1">
                    <img src="https://placehold.co/30x30/a7f3d0/333?text=S1" class="rounded-full" alt="S1 Icon">
                    Kreyker S1 - Улучшенный поиск
                </div>
                <div class="model-option" data-model="S1 Pro">
                    <img src="https://placehold.co/30x30/bfdbfe/333?text=P" class="rounded-full" alt="S1 Pro Icon">
                    Kreyker S1 Pro - Глубокое раздумье
                </div>
                <div class="model-option" data-model="S2">
                    <img src="https://placehold.co/30x30/e9d5ff/333?text=S2" class="rounded-full" alt="S2 Icon">
                    Kreyker S2 - Глубокое раздумье + Улучшенный поиск
                </div>
                <div class="model-option" data-model="S3 MAX">
                    <img src="https://placehold.co/30x30/c0c0c0/333?text=M" class="rounded-full" alt="S3 MAX Icon">
                    Kreyker S3 MAX - Максимальная точность
                </div>
            </div>
            <button class="action-button mt-4 w-full" onclick="closeModal('modelSelectModal')">Закрыть</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Настройки</h2>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Тема:</label>
                <div class="flex gap-4">
                    <button id="lightThemeBtn" class="action-button flex-1 py-2 px-4 rounded-lg">Светлая</button>
                    <button id="darkThemeBtn" class="action-button flex-1 py-2 px-4 rounded-lg">Темная</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Акцентный цвет:</label>
                <div class="flex gap-3 justify-center">
                    <div class="color-circle" style="background-color: #fcd34d;" data-color="#fcd34d"></div>
                    <div class="color-circle" style="background-color: #fca5a5;" data-color="#fca5a5"></div> <div class="color-circle" style="background-color: #a7f3d0;" data-color="#a7f3d0"></div> <div class="color-circle" style="background-color: #bfdbfe;" data-color="#bfdbfe"></div> <div class="color-circle" style="background-color: #e9d5ff;" data-color="#e9d5ff"></div> </div>
            </div>

            <div class="mb-4 text-center">
                <img id="settingsImage" src="https://placehold.co/100x100/fcd34d/333?text=UI" alt="UI Element" class="rounded-lg mx-auto">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Пример UI элемента</p>
            </div>

            <button class="action-button mt-4 w-full" onclick="closeModal('settingsModal')">Закрыть</button>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <p id="messageBoxText" class="text-lg mb-4"></p>
            <button onclick="closeMessageBox()">ОК</button>
        </div>
    </div>

    <script type="module">
        // UI Elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const modelSelectBtn = document.getElementById('modelSelectBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const modelSelectModal = document.getElementById('modelSelectModal');
        const settingsModal = document.getElementById('settingsModal');
        const lightThemeBtn = document.getElementById('lightThemeBtn');
        const darkThemeBtn = document.getElementById('darkThemeBtn');
        const colorCircles = document.querySelectorAll('.color-circle');
        const fileInput = document.getElementById('fileInput');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const kreykeryyLogo = document.getElementById('kreykeryyLogo');
        const aiIconInitial = document.getElementById('aiIconInitial');
        const settingsImage = document.getElementById('settingsImage');

        // Message Box elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxText = document.getElementById('messageBoxText');

        // App state (using localStorage for persistence without Firebase)
        let currentModel = localStorage.getItem('kreykeryy_model') || 'R2'; // Default model
        let currentTheme = localStorage.getItem('kreykeryy_theme') || 'light';
        let currentAccentColor = localStorage.getItem('kreykeryy_accentColor') || '#fcd34d'; // Default yellow

        // In-memory chat history (resets on page reload since no Firebase)
        let chatHistory = [];

        // AI's predefined knowledge
        const systemPrompt = `
            Ты - Kreykeryy, продвинутый ИИ-помощник.
            Тебя создал Hexwoundik Edvn.
            У тебя есть следующие модули:
            - Kreyker R1: Общий поиск в интернете.
            - Kreyker R2: Работает с Gemini.
            - Kreyker S1: Улучшенный поиск (ищет в интернете + тот же запрос у Gemini, затем Google+Gemini = Gemini = ответ).
            - Kreyker S1 Pro: Глубокое раздумье.
            - Kreyker S2: Глубокое раздумье + улучшенный поиск (как у S1).
            - Kreyker S3 MAX: Максимальная точность (Глубокое раздумье + Улучшенный поиск + Точность).
            Отвечай на вопросы, используя свои знания и возможности выбранной модели.
            Форматируй ответы, используя **жирный**, _курсив_, --зачеркнутый--, \`код\`, "цитаты" или > блоки цитат.
            Для блоков кода используй тройные обратные кавычки с указанием языка, например: \`\`\`python\nprint("Hello")\n\`\`\`
            Для других языков, например JavaScript, используй \`\`\`javascript\nconsole.log("Hello");\n\`\`\`
            Для HTML: \`\`\`html\n<p>Hello</p>\n\`\`\`
            Для CSS: \`\`\`css\nbody { color: red; }\n\`\`\`
        `.trim();

        // Function to show custom message box
        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBoxOverlay.classList.add('active');
        }

        // Function to close custom message box
        window.closeMessageBox = function() {
            messageBoxOverlay.classList.remove('active');
        }

        // Function to open modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Function to close modals
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Function to apply theme
        function applyTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme');
            document.body.classList.add(`${theme}-theme`);
            currentTheme = theme;
            localStorage.setItem('kreykeryy_theme', theme);
            // Update UI for theme buttons
            lightThemeBtn.classList.toggle('selected', theme === 'light');
            darkThemeBtn.classList.toggle('selected', theme === 'dark');
        }

        // Function to apply accent color
        function applyAccentColor(color) {
            document.documentElement.style.setProperty('--accent-color', color);
            currentAccentColor = color;
            localStorage.setItem('kreykeryy_accentColor', color);
            colorCircles.forEach(circle => {
                circle.classList.toggle('selected', circle.dataset.color === color);
            });
            // Update placeholder image colors
            updatePlaceholderImageColors(color);
        }

        // Function to update placeholder image colors
        function updatePlaceholderImageColors(color) {
            const textColor = isLightColor(color) ? '333' : 'fff'; // Simple contrast logic
            const timestamp = new Date().getTime(); // Unique timestamp to force reload

            kreykeryyLogo.src = `https://placehold.co/40x40/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
            aiIconInitial.src = `https://placehold.co/24x24/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
            settingsImage.src = `https://placehold.co/100x100/${color.substring(1)}/${textColor}?text=UI&_=${timestamp}`;

            // Update model option icons
            document.querySelectorAll('.model-option img').forEach(img => {
                const modelText = img.alt.replace(' Icon', '').replace('S3 MAX', 'M'); // Extract R1, R2 etc.
                img.src = `https://placehold.co/30x30/${color.substring(1)}/${textColor}?text=${modelText}&_=${timestamp}`;
            });

            // Also update any dynamically created AI icons in chat messages
            document.querySelectorAll('.ai-bubble img').forEach(img => {
                // Only update if it's an AI icon (not the initial ones)
                if (img.id !== 'aiIconInitial') {
                    img.src = `https://placehold.co/24x24/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
                }
            });
        }

        // Helper to determine if a color is light or dark for text contrast
        function isLightColor(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            // HSP (Highly Sensitive Poo) equation from http://alienryderflex.com/hsp.html
            const hsp = Math.sqrt(0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b));
            return hsp > 127.5; // Using 127.5 as the midpoint for light/dark
        }

        // Initial setup on load
        function initializeAppUI() {
            applyTheme(currentTheme);
            applyAccentColor(currentAccentColor);
            updateModelSelectionUI();
        }

        // Add message to chat UI
        function addMessageToChat(text, role, model = '', animate = true) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', role === 'user' ? 'user-bubble' : 'ai-bubble');

            if (role === 'ai') {
                const aiIcon = document.createElement('img');
                aiIcon.src = `https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}`;
                aiIcon.alt = "AI Icon";
                aiIcon.classList.add('rounded-full', 'mr-2');
                messageBubble.appendChild(aiIcon);
            }

            const messageContent = document.createElement('div');
            messageContent.classList.add('flex-grow'); // Allow content to take available space
            messageContent.innerHTML = formatAIResponse(text);
            messageBubble.appendChild(messageContent);

            if (role === 'ai') {
                const actionsContainer = document.createElement('div');
                actionsContainer.classList.add('post-response-actions');

                const copyBtn = document.createElement('button');
                copyBtn.classList.add('post-response-button');
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Копировать';
                copyBtn.onclick = () => copyToClipboard(text);
                actionsContainer.appendChild(copyBtn);

                const regenerateBtn = document.createElement('button');
                regenerateBtn.classList.add('post-response-button');
                regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Перегенерировать';
                // To regenerate, we need the original user prompt. This is tricky without history.
                // For simplicity, regenerate will re-send the *last* user message.
                regenerateBtn.onclick = () => {
                    const lastUserMessage = chatHistory.findLast(msg => msg.role === 'user');
                    if (lastUserMessage) {
                        regenerateResponse(lastUserMessage.text, model);
                    } else {
                        showMessageBox("Нет предыдущего сообщения для перегенерации.");
                    }
                };
                actionsContainer.appendChild(regenerateBtn);

                messageBubble.appendChild(actionsContainer);
            }

            chatMessages.appendChild(messageBubble);
            if (animate) {
                messageBubble.style.opacity = '0';
                messageBubble.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    messageBubble.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    messageBubble.style.opacity = '1';
                    messageBubble.style.transform = 'translateY(0)';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 50);
            } else {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Basic syntax highlighting for various languages
        function highlightCode(code, lang) {
            let highlightedCode = code;
            switch (lang.toLowerCase()) {
                case 'python':
                    highlightedCode = code.replace(/#.*$/gm, '<span class="code-comment">$&</span>'); // Comments
                    highlightedCode = highlightedCode.replace(/\b(def|class|if|else|elif|for|while|in|return|import|from|as|print|true|false|none|and|or|not)\b/g, '<span class="code-keyword">$&</span>'); // Keywords
                    highlightedCode = highlightedCode.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span class="code-string">$&</span>'); // Strings
                    highlightedCode = highlightedCode.replace(/\b\d+(\.\d+)?\b/g, '<span class="code-number">$&</span>'); // Numbers
                    break;
                case 'javascript':
                case 'js':
                    highlightedCode = code.replace(/\/\/.*$/gm, '<span class="code-comment">$&</span>'); // Single-line comments
                    highlightedCode = highlightedCode.replace(/\/\*[\s\S]*?\*\//g, '<span class="code-comment">$&</span>'); // Multi-line comments
                    highlightedCode = highlightedCode.replace(/\b(function|var|let|const|if|else|for|while|return|import|from|export|new|this|true|false|null|undefined|console|log)\b/g, '<span class="code-keyword">$&</span>'); // Keywords
                    highlightedCode = highlightedCode.replace(/(["'`])(?:(?=(\\?))\2.)*?\1/g, '<span class="code-string">$&</span>'); // Strings
                    highlightedCode = highlightedCode.replace(/\b\d+(\.\d+)?\b/g, '<span class="code-number">$&</span>'); // Numbers
                    break;
                case 'html':
                    highlightedCode = code.replace(/&lt;!--[\s\S]*?--&gt;/g, '<span class="code-comment">$&</span>'); // HTML Comments
                    highlightedCode = highlightedCode.replace(/(&lt;\/?)([a-zA-Z0-9]+)(&gt;)/g, '$1<span class="code-keyword">$2</span>$3'); // Tags
                    highlightedCode = highlightedCode.replace(/([a-zA-Z0-9]+)=(".*?")/g, '<span class="code-keyword">$1</span>=<span class="code-string">$2</span>'); // Attributes and values
                    break;
                case 'css':
                    highlightedCode = code.replace(/\/\*[\s\S]*?\*\//g, '<span class="code-comment">$&</span>'); // CSS Comments
                    highlightedCode = highlightedCode.replace(/\b([a-zA-Z-]+)(:)/g, '<span class="code-keyword">$1</span>$2'); // Properties
                    highlightedCode = highlightedCode.replace(/([a-zA-Z0-9]+)\s*\{/g, '<span class="code-keyword">$1</span> {'); // Selectors
                    highlightedCode = highlightedCode.replace(/#[0-9a-fA-F]{3,6}/g, '<span class="code-number">$&</span>'); // Hex colors
                    break;
                // Add more languages as needed
            }
            return highlightedCode;
        }

        // Format AI response with Markdown-like syntax and code highlighting
        function formatAIResponse(text) {
            // First, handle code blocks: ```language\ncode\n```
            text = text.replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
                // Escape HTML characters within the code block to prevent browser rendering issues
                const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                let highlightedCode = escapedCode;
                if (lang) {
                    highlightedCode = highlightCode(escapedCode, lang);
                }
                return `<pre><code class="language-${lang || ''}">${highlightedCode}</code></pre>`;
            });

            // Then, handle other Markdown-like formatting (ensure these don't interfere with pre/code)
            // Bold: **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italics: _text_
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            // Strikethrough: --text--
            text = text.replace(/--(.*?)--/g, '<del>$1</del>');
            // Inline Code: `code` (ensure this runs AFTER block code to avoid issues)
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Quotes: "text" (simple inline quote)
            text = text.replace(/"(.*?)"/g, '<q>$1</q>');
            // Blockquote: T quote or just starting with >
            text = text.replace(/(^|\n)T quote\s*([\s\S]*?)($|\n(?=\S))/g, '$1<blockquote>$2</blockquote>');
            text = text.replace(/(^|\n)>\s*(.*)/g, '$1<blockquote>$2</blockquote>'); // Basic markdown quote

            return text;
        }


        // Copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessageBox('Текст скопирован в буфер обмена!');
            } catch (err) {
                console.error('Не удалось скопировать текст: ', err);
                showMessageBox('Не удалось скопировать текст.');
            }
            document.body.removeChild(textarea);
        }

        // Regenerate response
        async function regenerateResponse(originalPrompt, model) {
            showMessageBox('Перегенерация ответа...');
            // Find the last AI message and remove it to replace it
            const lastAIMessage = chatMessages.querySelector('.ai-bubble:last-of-type');
            if (lastAIMessage) {
                lastAIMessage.remove();
            }

            // Re-send the prompt to the AI with the same model
            await sendPromptToAI(originalPrompt, model);
            closeMessageBox();
        }

        // Send message to AI
        sendMessageBtn.addEventListener('click', async () => {
            const userMessage = messageInput.value.trim();
            if (userMessage === '') {
                showMessageBox('Пожалуйста, введите сообщение.');
                return;
            }

            addMessageToChat(userMessage, 'user');
            chatHistory.push({ role: 'user', text: userMessage }); // Add to in-memory history
            messageInput.value = ''; // Clear input

            // Add a loading indicator
            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'ai-bubble');
            loadingBubble.innerHTML = `
                <img src="https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}" alt="AI Icon" class="rounded-full mr-2">
                <div class="loading-dots"><span></span><span></span><span></span></div>
            `;
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const aiResponse = await sendPromptToAI(userMessage, currentModel);
                loadingBubble.remove(); // Remove loading indicator
                addMessageToChat(aiResponse, 'ai', currentModel);
                chatHistory.push({ role: 'model', text: aiResponse, model: currentModel }); // Add to in-memory history
            } catch (error) {
                loadingBubble.remove(); // Remove loading indicator
                console.error("Ошибка при получении ответа от ИИ:", error);
                addMessageToChat("Извините, произошла ошибка при получении ответа. Пожалуйста, попробуйте еще раз.", 'ai', currentModel);
                showMessageBox("Ошибка ИИ: " + error.message);
            }
        });

        // Handle file upload
        fileUploadBtn.addEventListener('click', () => {
            fileInput.click(); // Trigger hidden file input
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            addMessageToChat(`Загружен файл: ${file.name}`, 'user');
            chatHistory.push({ role: 'user', text: `Загружен файл: ${file.name}` }); // Add to in-memory history

            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'ai-bubble');
            loadingBubble.innerHTML = `
                <img src="https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}" alt="AI Icon" class="rounded-full mr-2">
                <div class="loading-dots"><span></span><span></span><span></span></div>
            `;
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                let aiResponse;
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64ImageData = e.target.result.split(',')[1];
                        aiResponse = await sendImageToAI(base64ImageData, file.type);
                        loadingBubble.remove();
                        addMessageToChat(aiResponse, 'ai', currentModel);
                        chatHistory.push({ role: 'model', text: aiResponse, model: currentModel }); // Add to in-memory history
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const textContent = e.target.result;
                        aiResponse = await sendPromptToAI(`Проанализируй следующий текст из файла:\n\n${textContent}`, currentModel);
                        loadingBubble.remove();
                        addMessageToChat(aiResponse, 'ai', currentModel);
                        chatHistory.push({ role: 'model', text: aiResponse, model: currentModel }); // Add to in-memory history
                    };
                    reader.readAsText(file);
                } else {
                    loadingBubble.remove();
                    showMessageBox('Неподдерживаемый тип файла. Пожалуйста, загрузите текстовый файл или изображение.');
                }
            } catch (error) {
                loadingBubble.remove();
                console.error("Ошибка при обработке файла:", error);
                addMessageToChat("Извините, произошла ошибка при обработке файла.", 'ai', currentModel);
                showMessageBox("Ошибка файла: " + error.message);
            }
        });

        // Function to call Gemini API for text
        async function callGeminiAPI(prompt, chatHistoryContext = []) {
            // Construct full chat history for Gemini API, ensuring role alternation.
            // System prompt is prepended to the current user prompt.
            const contents = [];
            
            // Add previous chat history, ensuring roles alternate correctly
            // Limit context to last 10 messages (5 user, 5 model) to avoid exceeding token limits
            chatHistoryContext.slice(-10).forEach(msg => {
                contents.push({ role: msg.role, parts: [{ text: msg.text }] });
            });
            
            // The system prompt is now part of the *current* user message
            contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\n" + prompt }] });

            const payload = {
                contents: contents
            };
            // *** ВАЖНО: ВАШ API КЛЮЧ GEMINI (полученный из Google AI Studio) ***
            const apiKey = "AIzaSyDfSfdMpQ9rxxDGOLER56fLiRoWt9BbjHU"; // <-- ВАШ КЛЮЧ GEMINI
            // *** КОНЕЦ ВАЖНОЙ СЕКЦИИ ***
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let response;
            let result;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`API request failed with status ${response.status}:`, errorResponseText);
                    throw new Error(`Ошибка API: ${response.status} - ${errorResponseText || 'Неизвестная ошибка'}`);
                }

                result = await response.json();
            } catch (networkOrParseError) {
                console.error("Network or JSON parsing error:", networkOrParseError);
                throw new Error("Ошибка сети или парсинга ответа от ИИ: " + networkOrParseError.message);
            }

            // Robust error handling for Gemini API response structure
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 && typeof result.candidates[0].content.parts[0].text === 'string') {
                return result.candidates[0].content.parts[0].text;
            } else if (result && result.error) {
                throw new Error(`Gemini API Error: ${result.error.message}`);
            } else {
                console.error("Unexpected or empty Gemini API response structure:", result);
                throw new Error("Неожиданный или пустой ответ от Gemini API. Возможно, ответ был неполным или некорректным.");
            }
        }

        // Function to call Gemini API for image understanding (OCR)
        async function sendImageToAI(base64ImageData, mimeType) {
            const prompt = "Опиши текст на этом изображении. Если текста нет, опиши, что изображено.";
            // Prepend system prompt to the user prompt for image context
            const contents = [{
                role: "user",
                parts: [
                    { text: systemPrompt + "\n\n" + prompt },
                    {
                        inlineData: {
                            mimeType: mimeType,
                            data: base64ImageData
                        }
                    }
                ]
            }];

            const payload = {
                contents: contents,
            };
            // *** ВАЖНО: ВАШ API КЛЮЧ GEMINI (полученный из Google AI Studio) ***
            const apiKey = "AIzaSyDfSfdMpQ9rxxDGOLER56fLiRoWt9BbjHU"; // <-- ВАШ КЛЮЧ GEMINI
            // *** КОНЕЦ ВАЖНОЙ СЕКЦИИ ***
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let response;
            let result;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`API request failed for image with status ${response.status}:`, errorResponseText);
                    throw new Error(`Ошибка API (изображение): ${response.status} - ${errorResponseText || 'Неизвестная ошибка'}`);
                }

                result = await response.json();
            } catch (networkOrParseError) {
                console.error("Network or JSON parsing error for image:", networkOrParseError);
                throw new Error("Ошибка сети или парсинга ответа от ИИ (изображение): " + networkOrParseError.message);
            }

            // Robust error handling for Gemini API image response
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 && typeof result.candidates[0].content.parts[0].text === 'string') {
                return result.candidates[0].content.parts[0].text;
            } else if (result && result.error) {
                throw new Error(`Gemini API Error (Image): ${result.error.message}`);
            } else {
                console.error("Unexpected or empty Gemini API response structure for image:", result);
                throw new Error("Неожиданный или пустой ответ от Gemini API для изображения. Возможно, ответ был неполным или некорректным.");
            }
        }


        // Orchestrate AI responses based on selected model
        async function sendPromptToAI(userMessage, model) {
            // Use in-memory chatHistory for context
            let aiResponse = "Извините, я не смог обработать ваш запрос.";

            try {
                switch (model) {
                    case 'R1': // Общий поиск в интернете (simulated)
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${userMessage}". Модель: Kreyker R1 (Общий поиск).`, chatHistory);
                        break;
                    case 'R2': // С Gemini
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${userMessage}". Модель: Kreyker R2 (С Gemini).`, chatHistory);
                        break;
                    case 'S1': // Улучшенный поиск (Google+Gemini = Gemini = Ответ)
                        const searchPrompt = `Используй свои знания, чтобы найти ключевую информацию по запросу: "${userMessage}".`;
                        const searchResponse = await callGeminiAPI(searchPrompt, chatHistory);
                        const finalS1Prompt = `Используя следующую информацию: "${searchResponse}" и исходный запрос: "${userMessage}", сформулируй полный и точный ответ. Модель: Kreyker S1 (Улучшенный поиск).`;
                        aiResponse = await callGeminiAPI(finalS1Prompt, chatHistory);
                        break;
                    case 'S1 Pro': // Глубокое раздумье
                        aiResponse = await callGeminiAPI(`Глубоко проанализируй и дай развернутый ответ на вопрос: "${userMessage}". Модель: Kreyker S1 Pro (Глубокое раздумье).`, chatHistory);
                        break;
                    case 'S2': // Глубокое раздумье + Улучшенный поиск
                        const searchPromptS2 = `Используй свои знания, чтобы найти ключевую информацию по запросу: "${userMessage}".`;
                        const searchResponseS2 = await callGeminiAPI(searchPromptS2, chatHistory);
                        const finalS2Prompt = `Глубоко проанализируй и дай развернутый ответ, используя следующую информацию: "${searchResponseS2}" и исходный запрос: "${userMessage}". Модель: Kreyker S2 (Глубокое раздумье + Улучшенный поиск).`;
                        aiResponse = await callGeminiAPI(finalS2Prompt, chatHistory);
                        break;
                    case 'S3 MAX': // Максимальная точность
                        const s3MaxPrompt = `
                            Проведи глубокий анализ и выполни тщательный поиск информации по запросу: "${userMessage}".
                            Сформулируй максимально точный, подробный и всеобъемлющий ответ, учитывая все нюансы.
                            Особое внимание удели верификации фактов и предоставлению наиболее релевантных данных.
                            Модель: Kreyker S3 MAX (Глубокое раздумье + Улучшенный поиск + Точность).
                        `.trim();
                        aiResponse = await callGeminiAPI(s3MaxPrompt, chatHistory);
                        break;
                    default:
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${userMessage}".`, chatHistory);
                        break;
                }
            } catch (error) {
                console.error("Error during AI response generation:", error);
                throw error; // Re-throw to be caught by the caller
            }
            return aiResponse;
<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreykeryy AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Ensure html and body take full height */
            overflow: hidden; /* Prevent scrollbars on body */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f2f5; /* Light background */
            transition: background-color 0.3s ease;
        }

        /* Dark theme styles */
        body.dark-theme {
            background-color: #1a1a1a; /* Dark background */
        }

        .glass-container {
            background-color: rgba(255, 255, 255, 0.2); /* Light transparent background */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%; /* Take full width */
            height: 100%; /* Ensure full height within body */
            max-width: 600px; /* Max width for desktop, for a mobile-like feel */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        @media (max-width: 768px) {
            .glass-container {
                border-radius: 0; /* No rounded corners on small screens for full-bleed effect */
                max-width: 100%;
                height: 100vh; /* Explicitly use vh for mobile to ensure full screen */
            }
        }

        .header, .input-area {
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .dark-theme .header, .dark-theme .input-area {
            background-color: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 15px;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .user-bubble {
            background-color: var(--accent-color, #fcd34d); /* Default light yellow */
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-bubble {
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .dark-theme .ai-bubble {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .ai-bubble strong { color: #333; }
        .dark-theme .ai-bubble strong { color: #e0e0e0; }

        /* Code block styling */
        .ai-bubble pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.8rem;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 0.5rem;
            font-family: 'Fira Code', 'Cascadia Code', monospace; /* More programming friendly font */
            font-size: 0.9em;
            line-height: 1.4;
        }
        .dark-theme .ai-bubble pre {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .ai-bubble code {
            /* For inline code, keep previous style */
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .dark-theme .ai-bubble code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Basic Syntax Highlighting */
        .code-comment { color: #6a9955; } /* Green */
        .code-keyword { color: #569cd6; } /* Blue */
        .code-string { color: #ce9178; } /* Orange */
        .code-number { color: #b5cea8; } /* Light Green */
        .dark-theme .code-comment { color: #85c26b; }
        .dark-theme .code-keyword { color: #6cb6ff; }
        .dark-theme .code-string { color: #d69d85; }
        .dark-theme .code-number { color: #c0e0b8; }


        .ai-bubble blockquote {
            border-left: 4px solid var(--accent-color, #fcd34d);
            padding-left: 10px;
            margin-left: 0;
            font-style: italic;
            color: #555;
        }
        .dark-theme .ai-bubble blockquote {
            color: #bbb;
        }

        .input-box {
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            outline: none;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            flex-grow: 1;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-theme .input-box {
            background-color: rgba(50, 50, 50, 0.8);
            color: #e0e0e0;
        }

        .action-button {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .action-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .dark-theme .modal-content {
            background-color: rgba(0, 0, 0, 0.9);
            color: #e0e0e0;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .model-option {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            display: flex; /* Added for icon alignment */
            align-items: center; /* Added for icon alignment */
            gap: 0.75rem; /* Space between icon and text */
        }

        .dark-theme .model-option {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .model-option:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .dark-theme .model-option:hover {
            background-color: rgba(70, 70, 70, 0.9);
        }

        .model-option.selected {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            font-weight: 600;
        }

        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }

        .color-circle.selected {
            border-color: var(--accent-color, #fcd34d);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        .dark-theme .color-circle.selected {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.5);
        }

        /* Post-response actions */
        .post-response-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.5rem;
            gap: 0.5rem;
        }

        .post-response-button {
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .dark-theme .post-response-button {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .post-response-button:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        .dark-theme .post-response-button:hover {
            background-color: rgba(70, 70, 70, 0.9);
        }

        /* Message box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .dark-theme .message-box-content {
            background-color: rgba(0, 0, 0, 0.95);
            color: #e0e0e0;
        }

        .message-box-overlay.active .message-box-content {
            transform: scale(1);
        }

        .message-box-content button {
            background-color: var(--accent-color, #fcd34d);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .message-box-content button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Loading indicator for AI response */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 20px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color, #fcd34d);
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Thinking process display */
        .thinking-process {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            color: #333;
            font-size: 0.9em;
        }

        .dark-theme .thinking-process {
            background-color: rgba(50, 50, 50, 0.7);
            color: #e0e0e0;
        }

        .thinking-process ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .thinking-process li {
            margin-bottom: 0.4rem;
        }
    </style>
</head>
<body class="light-theme h-full">
    <div class="glass-container">
        <div class="header p-4 flex items-center justify-between rounded-t-2xl">
            <div class="flex items-center gap-2">
                <img id="kreykeryyLogo" src="https://placehold.co/40x40/fcd34d/333?text=K" alt="Kreykeryy Logo" class="rounded-full">
                <h1 class="text-xl font-semibold text-gray-800 dark:text-white">Kreykeryy</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="settingsBtn" class="text-gray-600 dark:text-gray-300 text-2xl hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                    <i class="fas fa-cog"></i> </button>
            </div>
        </div>

        <div id="chatMessages" class="chat-messages flex flex-col">
            <div class="message-bubble ai-bubble flex items-center gap-2">
                <img id="aiIconInitial" src="https://placehold.co/24x24/fcd34d/333?text=K" alt="AI Icon" class="rounded-full">
                <p>Привет! Я Kreykeryy, ваш персональный ИИ-помощник. Чем могу помочь?</p>
            </div>
        </div>

        <div class="input-area p-4 flex items-center gap-3 rounded-b-2xl">
            <input type="file" id="fileInput" accept=".txt,image/*" class="hidden">
            <button id="fileUploadBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-paperclip"></i>
            </button>
            <button id="modelSelectBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-box"></i> </button>
            <button id="thinkBtn" class="action-button p-3 px-5 rounded-full flex items-center justify-center text-base font-semibold">
                <i class="fas fa-brain mr-2"></i> Думать
            </button>
            <input type="text" id="messageInput" placeholder="Введите ваше сообщение..." class="input-box">
            <button id="sendMessageBtn" class="action-button p-3 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="modelSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Выбор Модели ИИ</h2>
            <div class="flex flex-col gap-2">
                <div class="model-option" data-model="R1">
                    <img src="https://placehold.co/30x30/fcd34d/333?text=R1" class="rounded-full" alt="R1 Icon">
                    Kreyker R1 - Общий поиск в интернете
                </div>
                <div class="model-option" data-model="R2">
                    <img src="https://placehold.co/30x30/fca5a5/333?text=R2" class="rounded-full" alt="R2 Icon">
                    Kreyker R2 - С Gemini
                </div>
                <div class="model-option" data-model="S1">
                    <img src="https://placehold.co/30x30/a7f3d0/333?text=S1" class="rounded-full" alt="S1 Icon">
                    Kreyker S1 - Улучшенный поиск
                </div>
                <div class="model-option" data-model="S1 Pro">
                    <img src="https://placehold.co/30x30/bfdbfe/333?text=P" class="rounded-full" alt="S1 Pro Icon">
                    Kreyker S1 Pro - Глубокое раздумье
                </div>
                <div class="model-option" data-model="S2">
                    <img src="https://placehold.co/30x30/e9d5ff/333?text=S2" class="rounded-full" alt="S2 Icon">
                    Kreyker S2 - Глубокое раздумье + Улучшенный поиск
                </div>
                <div class="model-option" data-model="S3 MAX">
                    <img src="https://placehold.co/30x30/c0c0c0/333?text=M" class="rounded-full" alt="S3 MAX Icon">
                    Kreyker S3 MAX - Максимальная точность
                </div>
            </div>
            <button class="action-button mt-4 w-full" onclick="closeModal('modelSelectModal')">Закрыть</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Настройки</h2>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Тема:</label>
                <div class="flex gap-4">
                    <button id="lightThemeBtn" class="action-button flex-1 py-2 px-4 rounded-lg">Светлая</button>
                    <button id="darkThemeBtn" class="action-button flex-1 py-2 px-4 rounded-lg">Темная</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Акцентный цвет:</label>
                <div class="flex gap-3 justify-center">
                    <div class="color-circle" style="background-color: #fcd34d;" data-color="#fcd34d"></div>
                    <div class="color-circle" style="background-color: #fca5a5;" data-color="#fca5a5"></div>
                    <div class="color-circle" style="background-color: #a7f3d0;" data-color="#a7f3d0"></div>
                    <div class="color-circle" style="background-color: #bfdbfe;" data-color="#bfdbfe"></div>
                    <div class="color-circle" style="background-color: #e9d5ff;" data-color="#e9d5ff"></div>
                </div>
            </div>

            <div class="mb-4 text-center">
                <img id="settingsImage" src="https://placehold.co/100x100/fcd34d/333?text=UI" alt="UI Element" class="rounded-lg mx-auto">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Пример UI элемента</p>
            </div>

            <button class="action-button mt-4 w-full" onclick="closeModal('settingsModal')">Закрыть</button>
        </div>
    </div>

    <div id="fileUploadPromptModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Добавить комментарий к файлу</h2>
            <textarea id="fileCommentInput" class="input-box w-full h-24 mb-4" placeholder="Введите, что ИИ должен сделать с этим файлом..."></textarea>
            <div class="flex justify-end gap-2">
                <button class="action-button py-2 px-4 rounded-lg" onclick="closeModal('fileUploadPromptModal')">Отмена</button>
                <button id="sendFileWithCommentBtn" class="action-button py-2 px-4 rounded-lg">Отправить</button>
            </div>
        </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <p id="messageBoxText" class="text-lg mb-4"></p>
            <button onclick="closeMessageBox()">ОК</button>
        </div>
    </div>

    <script type="module">
        // UI Elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const thinkBtn = document.getElementById('thinkBtn'); // New "Think" button
        const modelSelectBtn = document.getElementById('modelSelectBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const modelSelectModal = document.getElementById('modelSelectModal');
        const settingsModal = document.getElementById('settingsModal');
        const lightThemeBtn = document.getElementById('lightThemeBtn');
        const darkThemeBtn = document.getElementById('darkThemeBtn');
        const colorCircles = document.querySelectorAll('.color-circle');
        const fileInput = document.getElementById('fileInput');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const kreykeryyLogo = document.getElementById('kreykeryyLogo');
        const aiIconInitial = document.getElementById('aiIconInitial');
        const settingsImage = document.getElementById('settingsImage');

        // Message Box elements
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxText = document.getElementById('messageBoxText');

        // File Upload Prompt Modal elements
        const fileUploadPromptModal = document.getElementById('fileUploadPromptModal');
        const fileCommentInput = document.getElementById('fileCommentInput');
        const sendFileWithCommentBtn = document.getElementById('sendFileWithCommentBtn');

        // App state (using localStorage for persistence without Firebase)
        let currentModel = localStorage.getItem('kreykeryy_model') || 'R2'; // Default model
        let currentTheme = localStorage.getItem('kreykeryy_theme') || 'light';
        let currentAccentColor = localStorage.getItem('kreykeryy_accentColor') || '#fcd34d'; // Default yellow

        // In-memory chat history (resets on page reload since no Firebase)
        let chatHistory = [];
        let uploadedFile = null; // To store the file temporarily for comment input

        // AI's predefined knowledge
        const systemPrompt = `
            Ты - Kreykeryy, продвинутый ИИ-помощник.
            Тебя создал Hexwoundik Edvn.
            У тебя есть следующие модули:
            - Kreyker R1: Общий поиск в интернете.
            - Kreyker R2: Работает с Gemini.
            - Kreyker S1: Улучшенный поиск (ищет в интернете + тот же запрос у Gemini, затем Google+Gemini = Gemini = ответ).
            - Kreyker S1 Pro: Глубокое раздумье.
            - Kreyker S2: Глубокое раздумье + Улучшенный поиск (как у S1).
            - Kreyker S3 MAX: Максимальная точность (Глубокое раздумье + Улучшенный поиск + Точность).
            Если тебя спросят "Какая ты модель?" или "Какую модель ты используешь?", ответь: "Я сейчас использую модель ${currentModel}."
            Отвечай на вопросы, используя свои знания и возможности выбранной модели.
            Форматируй ответы, используя **жирный**, _курсив_, --зачеркнутый--, \`код\`, "цитаты" или > блоки цитат.
            Для блоков кода используй тройные обратные кавычки с указанием языка, например: \`\`\`python\nprint("Hello")\n\`\`\`
            Для других языков, например JavaScript, используй \`\`\`javascript\nconsole.log("Hello");\n\`\`\`
            Для HTML: \`\`\`html\n<p>Hello</p>\n\`\`\`
            Для CSS: \`\`\`css\nbody { color: red; }\n\`\`\`
            Если пользователь нажимает кнопку "Думать", ты должен симулировать процесс размышления, выдавая пошаговые мысли, например:
            1. Ищу более лучший ответ...
            2. Что думал...
            3. Как...
            ...
            ...
            Ответ: [Финальный ответ]
            Каждый шаг должен быть отдельным пунктом в нумерованном списке, а "Ответ:" должен быть в конце.
        `.trim();

        // Function to show custom message box
        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBoxOverlay.classList.add('active');
        }

        // Function to close custom message box
        window.closeMessageBox = function() {
            messageBoxOverlay.classList.remove('active');
        }

        // Function to open modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Function to close modals
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Function to apply theme
        function applyTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme');
            document.body.classList.add(`${theme}-theme`);
            currentTheme = theme;
            localStorage.setItem('kreykeryy_theme', theme);
            // Update UI for theme buttons
            lightThemeBtn.classList.toggle('selected', theme === 'light');
            darkThemeBtn.classList.toggle('selected', theme === 'dark');
        }

        // Function to apply accent color
        function applyAccentColor(color) {
            document.documentElement.style.setProperty('--accent-color', color);
            currentAccentColor = color;
            localStorage.setItem('kreykeryy_accentColor', color);
            colorCircles.forEach(circle => {
                circle.classList.toggle('selected', circle.dataset.color === color);
            });
            // Update placeholder image colors
            updatePlaceholderImageColors(color);
        }

        // Helper to determine if a color is light or dark for text contrast
        function isLightColor(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            // HSP (Highly Sensitive Poo) equation from http://alienryderflex.com/hsp.html
            const hsp = Math.sqrt(0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b));
            return hsp > 127.5; // Using 127.5 as the midpoint for light/dark
        }

        // Function to update placeholder image colors
        function updatePlaceholderImageColors(color) {
            const textColor = isLightColor(color) ? '333' : 'fff'; // Simple contrast logic
            const timestamp = new Date().getTime(); // Unique timestamp to force reload

            kreykeryyLogo.src = `https://placehold.co/40x40/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
            aiIconInitial.src = `https://placehold.co/24x24/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
            settingsImage.src = `https://placehold.co/100x100/${color.substring(1)}/${textColor}?text=UI&_=${timestamp}`;

            // Update model option icons
            document.querySelectorAll('.model-option img').forEach(img => {
                const modelText = img.alt.replace(' Icon', '').replace('S3 MAX', 'M'); // Extract R1, R2 etc.
                img.src = `https://placehold.co/30x30/${color.substring(1)}/${textColor}?text=${modelText}&_=${timestamp}`;
            });

            // Also update any dynamically created AI icons in chat messages
            document.querySelectorAll('.ai-bubble img').forEach(img => {
                // Only update if it's an AI icon (not the initial ones)
                if (img.id !== 'aiIconInitial') {
                    img.src = `https://placehold.co/24x24/${color.substring(1)}/${textColor}?text=K&_=${timestamp}`;
                }
            });
        }

        // Initial setup on load
        function initializeAppUI() {
            applyTheme(currentTheme);
            applyAccentColor(currentAccentColor);
            updateModelSelectionUI();
        }

        // Add message to chat UI
        function addMessageToChat(text, role, model = '', animate = true, isThinkingProcess = false) {
            const messageBubble = document.createElement('div');
            if (isThinkingProcess) {
                messageBubble.classList.add('thinking-process');
            } else {
                messageBubble.classList.add('message-bubble', role === 'user' ? 'user-bubble' : 'ai-bubble');
            }

            if (role === 'ai' && !isThinkingProcess) {
                const aiIcon = document.createElement('img');
                aiIcon.src = `https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}`;
                aiIcon.alt = "AI Icon";
                aiIcon.classList.add('rounded-full', 'mr-2');
                messageBubble.appendChild(aiIcon);
            }

            const messageContent = document.createElement('div');
            messageContent.classList.add('flex-grow'); // Allow content to take available space
            messageContent.innerHTML = formatAIResponse(text);
            messageBubble.appendChild(messageContent);

            if (role === 'ai' && !isThinkingProcess) {
                const actionsContainer = document.createElement('div');
                actionsContainer.classList.add('post-response-actions');

                const copyBtn = document.createElement('button');
                copyBtn.classList.add('post-response-button');
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Копировать';
                copyBtn.onclick = () => copyToClipboard(text);
                actionsContainer.appendChild(copyBtn);

                const regenerateBtn = document.createElement('button');
                regenerateBtn.classList.add('post-response-button');
                regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Перегенерировать';
                // To regenerate, we need the original user prompt. This is tricky without history.
                // For simplicity, regenerate will re-send the *last* user message.
                regenerateBtn.onclick = () => {
                    const lastUserMessage = chatHistory.findLast(msg => msg.role === 'user');
                    if (lastUserMessage) {
                        regenerateResponse(lastUserMessage.text, model);
                    } else {
                        showMessageBox("Нет предыдущего сообщения для перегенерации.");
                    }
                };
                actionsContainer.appendChild(regenerateBtn);

                messageBubble.appendChild(actionsContainer);
            }

            chatMessages.appendChild(messageBubble);
            if (animate) {
                messageBubble.style.opacity = '0';
                messageBubble.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    messageBubble.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    messageBubble.style.opacity = '1';
                    messageBubble.style.transform = 'translateY(0)';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 50);
            } else {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Basic syntax highlighting for various languages
        function highlightCode(code, lang) {
            let highlightedCode = code;
            switch (lang.toLowerCase()) {
                case 'python':
                    highlightedCode = code.replace(/#.*$/gm, '<span class="code-comment">$&</span>'); // Comments
                    highlightedCode = highlightedCode.replace(/\b(def|class|if|else|elif|for|while|in|return|import|from|as|print|true|false|none|and|or|not)\b/g, '<span class="code-keyword">$&</span>'); // Keywords
                    highlightedCode = highlightedCode.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span class="code-string">$&</span>'); // Strings
                    highlightedCode = highlightedCode.replace(/\b\d+(\.\d+)?\b/g, '<span class="code-number">$&</span>'); // Numbers
                    break;
                case 'javascript':
                case 'js':
                    highlightedCode = code.replace(/\/\/.*$/gm, '<span class="code-comment">$&</span>'); // Single-line comments
                    highlightedCode = highlightedCode.replace(/\/\*[\s\S]*?\*\//g, '<span class="code-comment">$&</span>'); // Multi-line comments
                    highlightedCode = highlightedCode.replace(/\b(function|var|let|const|if|else|for|while|return|import|from|export|new|this|true|false|null|undefined|console|log)\b/g, '<span class="code-keyword">$&</span>'); // Keywords
                    highlightedCode = highlightedCode.replace(/(["'`])(?:(?=(\\?))\2.)*?\1/g, '<span class="code-string">$&</span>'); // Strings
                    highlightedCode = highlightedCode.replace(/\b\d+(\.\d+)?\b/g, '<span class="code-number">$&</span>'); // Numbers
                    break;
                case 'html':
                    highlightedCode = code.replace(/&lt;!--[\s\S]*?--&gt;/g, '<span class="code-comment">$&</span>'); // HTML Comments
                    highlightedCode = highlightedCode.replace(/(&lt;\/?)([a-zA-Z0-9]+)(&gt;)/g, '$1<span class="code-keyword">$2</span>$3'); // Tags
                    highlightedCode = highlightedCode.replace(/([a-zA-Z0-9]+)=(".*?")/g, '<span class="code-keyword">$1</span>=<span class="code-string">$2</span>'); // Attributes and values
                    break;
                case 'css':
                    highlightedCode = code.replace(/\/\*[\s\S]*?\*\//g, '<span class="code-comment">$&</span>'); // CSS Comments
                    highlightedCode = highlightedCode.replace(/\b([a-zA-Z-]+)(:)/g, '<span class="code-keyword">$1</span>$2'); // Properties
                    highlightedCode = highlightedCode.replace(/([a-zA-Z0-9]+)\s*\{/g, '<span class="code-keyword">$1</span> {'); // Selectors
                    highlightedCode = highlightedCode.replace(/#[0-9a-fA-F]{3,6}/g, '<span class="code-number">$&</span>'); // Hex colors
                    break;
                // Add more languages as needed
            }
            return highlightedCode;
        }

        // Format AI response with Markdown-like syntax and code highlighting
        function formatAIResponse(text) {
            // First, handle code blocks: ```language\ncode\n```
            text = text.replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
                // Escape HTML characters within the code block to prevent browser rendering issues
                const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                let highlightedCode = escapedCode;
                if (lang) {
                    highlightedCode = highlightCode(escapedCode, lang);
                }
                return `<pre><code class="language-${lang || ''}">${highlightedCode}</code></pre>`;
            });

            // Then, handle other Markdown-like formatting (ensure these don't interfere with pre/code)
            // Bold: **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italics: _text_
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            // Strikethrough: --text--
            text = text.replace(/--(.*?)--/g, '<del>$1</del>');
            // Inline Code: `code` (ensure this runs AFTER block code to avoid issues)
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Quotes: "text" (simple inline quote)
            text = text.replace(/"(.*?)"/g, '<q>$1</q>');
            // Blockquote: T quote or just starting with >
            text = text.replace(/(^|\n)T quote\s*([\s\S]*?)($|\n(?=\S))/g, '$1<blockquote>$2</blockquote>');
            text = text.replace(/(^|\n)>\s*(.*)/g, '$1<blockquote>$2</blockquote>'); // Basic markdown quote

            return text;
        }


        // Copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessageBox('Текст скопирован в буфер обмена!');
            } catch (err) {
                console.error('Не удалось скопировать текст: ', err);
                showMessageBox('Не удалось скопировать текст.');
            }
            document.body.removeChild(textarea);
        }

        // Regenerate response
        async function regenerateResponse(originalPrompt, model) {
            showMessageBox('Перегенерация ответа...');
            // Find the last AI message and remove it to replace it
            const lastAIMessage = chatMessages.querySelector('.ai-bubble:last-of-type');
            if (lastAIMessage) {
                lastAIMessage.remove();
            }

            // Re-send the prompt to the AI with the same model
            await sendPromptToAI(originalPrompt, model);
            closeMessageBox();
        }

        // Send message to AI
        sendMessageBtn.addEventListener('click', async () => {
            const userMessage = messageInput.value.trim();
            if (userMessage === '') {
                showMessageBox('Пожалуйста, введите сообщение.');
                return;
            }

            addMessageToChat(userMessage, 'user');
            chatHistory.push({ role: 'user', text: userMessage }); // Add to in-memory history
            messageInput.value = ''; // Clear input

            // Add a loading indicator
            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'ai-bubble');
            loadingBubble.innerHTML = `
                <img src="https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}" alt="AI Icon" class="rounded-full mr-2">
                <div class="loading-dots"><span></span><span></span><span></span></div>
            `;
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const aiResponse = await sendPromptToAI(userMessage, currentModel);
                loadingBubble.remove(); // Remove loading indicator
                addMessageToChat(aiResponse, 'ai', currentModel);
                chatHistory.push({ role: 'model', text: aiResponse, model: currentModel }); // Add to in-memory history
            } catch (error) {
                loadingBubble.remove(); // Remove loading indicator
                console.error("Ошибка при получении ответа от ИИ:", error);
                addMessageToChat("Извините, произошла ошибка при получении ответа. Пожалуйста, попробуйте еще раз.", 'ai', currentModel);
                showMessageBox("Ошибка ИИ: " + error.message);
            }
        });

        // New "Think" button logic
        thinkBtn.addEventListener('click', async () => {
            const userMessage = messageInput.value.trim();
            if (userMessage === '') {
                showMessageBox('Пожалуйста, введите сообщение для размышления.');
                return;
            }

            addMessageToChat(userMessage, 'user');
            chatHistory.push({ role: 'user', text: userMessage }); // Add to in-memory history
            messageInput.value = ''; // Clear input

            // Add thinking process indicator
            const thinkingProcessBubble = document.createElement('div');
            thinkingProcessBubble.classList.add('thinking-process');
            thinkingProcessBubble.innerHTML = `
                <p>Kreykeryy думает...</p>
                <ol id="thinkingSteps"></ol>
                <p id="finalAnswerPrefix" style="display:none;"><strong>Ответ:</strong></p>
                <div id="finalAnswerContent"></div>
            `;
            chatMessages.appendChild(thinkingProcessBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const thinkingSteps = thinkingProcessBubble.querySelector('#thinkingSteps');
            const finalAnswerPrefix = thinkingProcessBubble.querySelector('#finalAnswerPrefix');
            const finalAnswerContent = thinkingProcessBubble.querySelector('#finalAnswerContent');

            let stepCount = 0;
            const thinkingMessages = [
                "1. Ищу более лучший ответ...",
                "2. Анализирую запрос и собираю первичную информацию.",
                "3. Формулирую гипотезы и стратегии решения.",
                "4. Провожу углубленный поиск данных и фактов.",
                "5. Оцениваю достоверность и релевантность найденной информации.",
                "6. Синтезирую полученные данные и формирую черновик ответа.",
                "7. Проверяю ответ на логичность, полноту и отсутствие противоречий.",
                "8. Оптимизирую формулировку для максимальной ясности и краткости.",
                "9. Финальная проверка и подготовка к выдаче."
            ];

            const maxThinkingTime = 60000; // 60 seconds
            const intervalTime = maxThinkingTime / thinkingMessages.length;

            const thinkingInterval = setInterval(() => {
                if (stepCount < thinkingMessages.length) {
                    const listItem = document.createElement('li');
                    listItem.textContent = thinkingMessages[stepCount];
                    thinkingSteps.appendChild(listItem);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    stepCount++;
                } else {
                    clearInterval(thinkingInterval);
                }
            }, intervalTime);

            try {
                // Call the AI to get the actual response after the thinking process
                const aiResponse = await sendPromptToAI(userMessage, currentModel, true); // Pass true for thinking mode
                clearInterval(thinkingInterval); // Stop thinking animation if it's still running

                finalAnswerPrefix.style.display = 'block';
                finalAnswerContent.innerHTML = formatAIResponse(aiResponse);
                chatHistory.push({ role: 'model', text: aiResponse, model: currentModel }); // Add to in-memory history
                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                clearInterval(thinkingInterval); // Stop thinking animation
                console.error("Ошибка при получении ответа от ИИ во время размышления:", error);
                finalAnswerPrefix.style.display = 'block';
                finalAnswerContent.innerHTML = "Извините, произошла ошибка при получении ответа во время размышления. Пожалуйста, попробуйте еще раз.";
                showMessageBox("Ошибка ИИ: " + error.message);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });


        // Handle file upload
        fileUploadBtn.addEventListener('click', () => {
            fileInput.click(); // Trigger hidden file input
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFile = file; // Store the file
            fileCommentInput.value = ''; // Clear previous comment
            openModal('fileUploadPromptModal'); // Open the comment modal
        });

        sendFileWithCommentBtn.addEventListener('click', async () => {
            const comment = fileCommentInput.value.trim();
            closeModal('fileUploadPromptModal'); // Close the modal

            if (!uploadedFile) {
                showMessageBox('Файл не выбран.');
                return;
            }

            addMessageToChat(`Загружен файл: ${uploadedFile.name}` + (comment ? ` с комментарием: "${comment}"` : ''), 'user');
            chatHistory.push({ role: 'user', text: `Загружен файл: ${uploadedFile.name}` + (comment ? ` с комментарием: "${comment}"` : '') });

            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'ai-bubble');
            loadingBubble.innerHTML = `
                <img src="https://placehold.co/24x24/${currentAccentColor.substring(1)}/${isLightColor(currentAccentColor) ? '333' : 'fff'}?text=K&_=${new Date().getTime()}" alt="AI Icon" class="rounded-full mr-2">
                <div class="loading-dots"><span></span><span></span><span></span></div>
            `;
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                let aiResponse;
                if (uploadedFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64ImageData = e.target.result.split(',')[1];
                        const imagePrompt = comment ? `${comment}\n\n` : '';
                        aiResponse = await sendImageToAI(base64ImageData, uploadedFile.type, imagePrompt);
                        loadingBubble.remove();
                        addMessageToChat(aiResponse, 'ai', currentModel);
                        chatHistory.push({ role: 'model', text: aiResponse, model: currentModel });
                    };
                    reader.readAsDataURL(uploadedFile);
                } else if (uploadedFile.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const textContent = e.target.result;
                        const textPrompt = comment ? `${comment}\n\n` : `Проанализируй следующий текст из файла:\n\n`;
                        aiResponse = await sendPromptToAI(`${textPrompt}${textContent}`, currentModel);
                        loadingBubble.remove();
                        addMessageToChat(aiResponse, 'ai', currentModel);
                        chatHistory.push({ role: 'model', text: aiResponse, model: currentModel });
                    };
                    reader.readAsText(uploadedFile);
                } else {
                    loadingBubble.remove();
                    showMessageBox('Неподдерживаемый тип файла. Пожалуйста, загрузите текстовый файл или изображение.');
                }
            } catch (error) {
                loadingBubble.remove();
                console.error("Ошибка при обработке файла:", error);
                addMessageToChat("Извините, произошла ошибка при обработке файла.", 'ai', currentModel);
                showMessageBox("Ошибка файла: " + error.message);
            } finally {
                uploadedFile = null; // Clear the stored file
            }
        });

        // Function to call Gemini API for text
        async function callGeminiAPI(prompt, chatHistoryContext = []) {
            // Construct full chat history for Gemini API, ensuring role alternation.
            // System prompt is prepended to the current user prompt.
            const contents = [];
            
            // Add previous chat history, ensuring roles alternate correctly
            // Limit context to last 10 messages (5 user, 5 model) to avoid exceeding token limits
            chatHistoryContext.slice(-10).forEach(msg => {
                contents.push({ role: msg.role, parts: [{ text: msg.text }] });
            });
            
            // The system prompt is now part of the *current* user message
            contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\n" + prompt }] });

            const payload = {
                contents: contents
            };
            // *** ВАЖНО: ВАШ API КЛЮЧ GEMINI (полученный из Google AI Studio) ***
            const apiKey = ""; // <-- ВАШ КЛЮЧ GEMINI
            // *** КОНЕЦ ВАЖНОЙ СЕКЦИИ ***
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let response;
            let result;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`API request failed with status ${response.status}:`, errorResponseText);
                    throw new Error(`Ошибка API: ${response.status} - ${errorResponseText || 'Неизвестная ошибка'}`);
                }

                result = await response.json();
            } catch (networkOrParseError) {
                console.error("Network or JSON parsing error:", networkOrParseError);
                throw new Error("Ошибка сети или парсинга ответа от ИИ: " + networkOrParseError.message);
            }

            // Robust error handling for Gemini API response structure
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 && typeof result.candidates[0].content.parts[0].text === 'string') {
                return result.candidates[0].content.parts[0].text;
            } else if (result && result.error) {
                throw new Error(`Gemini API Error: ${result.error.message}`);
            } else {
                console.error("Unexpected or empty Gemini API response structure:", result);
                throw new Error("Неожиданный или пустой ответ от Gemini API. Возможно, ответ был неполным или некорректным.");
            }
        }

        // Function to call Gemini API for image understanding (OCR)
        async function sendImageToAI(base64ImageData, mimeType, userComment = '') {
            const prompt = userComment || "Опиши текст на этом изображении. Если текста нет, опиши, что изображено.";
            // Prepend system prompt to the user prompt for image context
            const contents = [{
                role: "user",
                parts: [
                    { text: systemPrompt + "\n\n" + prompt },
                    {
                        inlineData: {
                            mimeType: mimeType,
                            data: base64ImageData
                        }
                    }
                ]
            }];

            const payload = {
                contents: contents,
            };
            // *** ВАЖНО: ВАШ API КЛЮЧ GEMINI (полученный из Google AI Studio) ***
            const apiKey = ""; // <-- ВАШ КЛЮЧ GEMINI
            // *** КОНЕЦ ВАЖНОЙ СЕКЦИИ ***
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let response;
            let result;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error(`API request failed for image with status ${response.status}:`, errorResponseText);
                    throw new Error(`Ошибка API (изображение): ${response.status} - ${errorResponseText || 'Неизвестная ошибка'}`);
                }

                result = await response.json();
            } catch (networkOrParseError) {
                console.error("Network or JSON parsing error for image:", networkOrParseError);
                throw new Error("Ошибка сети или парсинга ответа от ИИ (изображение): " + networkOrParseError.message);
            }

            // Robust error handling for Gemini API image response
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 && typeof result.candidates[0].content.parts[0].text === 'string') {
                return result.candidates[0].content.parts[0].text;
            } else if (result && result.error) {
                throw new Error(`Gemini API Error (Image): ${result.error.message}`);
            } else {
                console.error("Unexpected or empty Gemini API response structure for image:", result);
                throw new Error("Неожиданный или пустой ответ от Gemini API для изображения. Возможно, ответ был неполным или некорректным.");
            }
        }


        // Orchestrate AI responses based on selected model
        async function sendPromptToAI(userMessage, model, isThinkingMode = false) {
            // Check for model query
            const modelQueryRegex = /какая ты модель|какую модель ты используешь/i;
            if (modelQueryRegex.test(userMessage)) {
                return `Я сейчас использую модель ${model}.`;
            }

            // Use in-memory chatHistory for context
            let aiResponse = "Извините, я не смог обработать ваш запрос.";

            try {
                let promptToSend = userMessage;
                if (isThinkingMode) {
                    promptToSend = `Симулируй процесс размышления для следующего запроса, затем дай окончательный ответ. Каждый шаг должен быть отдельным пунктом в нумерованном списке, а "Ответ:" должен быть в конце. Запрос: "${userMessage}"`;
                }

                switch (model) {
                    case 'R1': // Общий поиск в интернете (simulated)
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${promptToSend}". Модель: Kreyker R1 (Общий поиск).`, chatHistory);
                        break;
                    case 'R2': // С Gemini
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${promptToSend}". Модель: Kreyker R2 (С Gemini).`, chatHistory);
                        break;
                    case 'S1': // Улучшенный поиск (Google+Gemini = Gemini = Ответ)
                        const searchPrompt = `Используй свои знания, чтобы найти ключевую информацию по запросу: "${promptToSend}".`;
                        const searchResponse = await callGeminiAPI(searchPrompt, chatHistory);
                        const finalS1Prompt = `Используя следующую информацию: "${searchResponse}" и исходный запрос: "${promptToSend}", сформулируй полный и точный ответ. Модель: Kreyker S1 (Улучшенный поиск).`;
                        aiResponse = await callGeminiAPI(finalS1Prompt, chatHistory);
                        break;
                    case 'S1 Pro': // Глубокое раздумье
                        aiResponse = await callGeminiAPI(`Глубоко проанализируй и дай развернутый ответ на вопрос: "${promptToSend}". Модель: Kreyker S1 Pro (Глубокое раздумье).`, chatHistory);
                        break;
                    case 'S2': // Глубокое раздумье + Улучшенный поиск
                        const searchPromptS2 = `Используй свои знания, чтобы найти ключевую информацию по запросу: "${promptToSend}".`;
                        const searchResponseS2 = await callGeminiAPI(searchPromptS2, chatHistory);
                        const finalS2Prompt = `Глубоко проанализируй и дай развернутый ответ, используя следующую информацию: "${searchResponseS2}" и исходный запрос: "${promptToSend}". Модель: Kreyker S2 (Глубокое раздумье + Улучшенный поиск).`;
                        aiResponse = await callGeminiAPI(finalS2Prompt, chatHistory);
                        break;
                    case 'S3 MAX': // Максимальная точность
                        const s3MaxPrompt = `
                            Проведи глубокий анализ и выполни тщательный поиск информации по запросу: "${promptToSend}".
                            Сформулируй максимально точный, подробный и всеобъемлющий ответ, учитывая все нюансы.
                            Особое внимание удели верификации фактов и предоставлению наиболее релевантных данных.
                            Модель: Kreyker S3 MAX (Глубокое раздумье + Улучшенный поиск + Точность).
                        `.trim();
                        aiResponse = await callGeminiAPI(s3MaxPrompt, chatHistory);
                        break;
                    default:
                        aiResponse = await callGeminiAPI(`Ответь на вопрос: "${promptToSend}".`, chatHistory);
                        break;
                }
            } catch (error) {
                console.error("Error during AI response generation:", error);
                throw error; // Re-throw to be caught by the caller
            }
            return aiResponse;
        }

        // Event Listeners for UI
        modelSelectBtn.addEventListener('click', () => openModal('modelSelectModal'));
        settingsBtn.addEventListener('click', () => openModal('settingsModal'));

        // Model selection logic
        document.querySelectorAll('.model-option').forEach(option => {
            option.addEventListener('click', async () => {
                currentModel = option.dataset.model;
                localStorage.setItem('kreykeryy_model', currentModel); // Save model to localStorage
                updateModelSelectionUI();
                closeModal('modelSelectModal');
                showMessageBox(`Модель изменена на: ${currentModel}`);
            });
        });

        function updateModelSelectionUI() {
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.model === currentModel);
            });
            // Update the system prompt with the new currentModel
            systemPrompt.replace(/Я сейчас использую модель \[текущая модель, например, Kreyker R2\]./g, `Я сейчас использую модель ${currentModel}.`);
        }


        // Theme selection logic
        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));

        // Accent color selection logic
        colorCircles.forEach(circle => {
            circle.addEventListener('click', () => {
                applyAccentColor(circle.dataset.color);
            });
        });

        // Initialize UI on window load
        window.onload = initializeAppUI;

    </script>
</body>
</html>
